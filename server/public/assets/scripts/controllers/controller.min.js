/*! rtc.io 2016-02-01 */
var myApp=angular.module("myApp");myApp.controller("LobbyController",["$scope","ngAudio","$location","redirector",function(a,b,c,d){console.log("lobby controller");var e=io.connect("http://localhost:5000");a.option="",a.kiosk=!1,a.user=!1,a.options=["visitor","option1","option2","option3","option4","option5","option6"],a.newArray=[],a.loggedIn=!1,a.link=!1,a.unavailable=!1,a.i=0,a.answered=!1,a.whatever=d.wasRedirected,console.log(a.whatever),e.on("optionArray",function(b){a.newArray=[],a.newArray=b.array;for(var c=0;c<a.options.length;c++)for(var d=0;d<a.newArray.length;d++)a.options[c]==a.newArray[d]&&a.options.splice(c,1)}),e.on("entrance",function(a){}),e.on("call",function(a){console.log("a call has been made")}),e.on("invite",function(b){console.log("you have been invited"+b.link),a.incomingCall(),a.soundFunction()}),e.on("accepted",function(b){a.acceptedFunction()}),e.on("unavailable",function(b){a.unavailable=!scope.unavailable}),e.on("exit",function(a){}),a.soundFunction=function(){a.i++,a.audio=b.load("http://www.soundjay.com/phone/sounds/telephone-ring-03a.mp3"),a.audio.play(),console.log("ring "+a.i),a.i<4&&0==a.answered?setTimeout(a.soundFunction,6e3):a.i>=4&&0==a.answered&&(console.log(a.option),e.emit("noAnswer",{option:a.option}),a.i=0,a.link=!1)},a.incomingCall=function(b){a.link=!0},a.receivingCall=function(){console.log("i am taking the call"),e.emit("callAccepted")},a.kioskLogin=function(){a.getOptions(),a.kiosk=!a.kiosk},a.acceptedFunction=function(){a.link=!1,a.answered=!0},a.getOptions=function(){e.emit("getOptions")},a.callFunction=function(){e.emit("call",{call:a.option})},a.loginFunction=function(b){console.log(a.kiosk,a.user),console.log(b),a.loggedIn=!a.loggedIn,e.emit("login",{option:b}),"visitor"==b?a.kiosk=!a.kiosk:a.user=!a.user,console.log(a.kiosk,a.user)},a.getOptions()}]),myApp.controller("VideoChatController",["$scope","$location","redirector",function(a,b,c){function d(a){z.emit("message",a)}function f(a){console.log("Adding local stream."),N.src=window.URL.createObjectURL(a),C=a,d("Got user media"),$("#localimg").hide(),$("#localVideo").show(),I&&h()}function g(a){console.log("navigator.getUserMedia error: ",a)}function h(){!J&&"undefined"!=typeof C&&B&&(i(),E.addStream(C),J=!0,I&&p())}function i(){try{var a=null;E=new l(a,{optional:[{RtpDataChannels:!0}]}),E.onicecandidate=m,E.onaddstream=n,E.onremovestream=u}catch(b){return console.log("Failed to create PeerConnection, exception: "+b.message),void alert("Cannot create RTCPeerConnection object.")}}function j(a){return K?new mozRTCSessionDescription(a):new RTCSessionDescription(a)}function k(a){return K?new mozRTCIceCandidate(a):new RTCIceCandidate(a)}function l(a){return K?new mozRTCPeerConnection(a):new webkitRTCPeerConnection(a)}function m(a){a.candidate?d({type:"candidate",label:a.candidate.sdpMLineIndex,id:a.candidate.sdpMid,candidate:a.candidate.candidate}):(console.log("End of candidates."),$("#remoteimg").hide(),$("#remoteVideo").show())}function n(a){console.log("Remote stream added."),O.src=window.URL.createObjectURL(a.stream),D=a.stream}function o(a){console.log("createOffer() error: ",e)}function p(){console.log("Sending offer to peer"),E.createOffer(r,o)}function q(){console.log("Sending answer to peer."),K?E.createAnswer(r,s,M):E.createAnswer(r,null,M)}function r(a){a.sdp=v(a.sdp),E.setLocalDescription(a),d(a)}function s(a){console.log("createAnswer() error: ",e)}function t(a){var b=!1;for(var c in L.iceServers)if("turn:"===L.iceServers[c].url.substr(0,5)){b=!0,F=!0;break}if(!b){console.log("Getting TURN server from ",a);var d=new XMLHttpRequest;d.onreadystatechange=function(){if(4===d.readyState&&200===d.status){var a=JSON.parse(d.responseText);console.log("Got TURN server: ",a),L.iceServers.push({url:"turn:"+a.username+"@"+a.turn,credential:a.password}),F=!0}},d.open("GET",a,!0),d.send()}}function n(a){console.log("Remote stream added."),O.src=window.URL.createObjectURL(a.stream),D=a.stream}function u(a){console.log("Remote stream removed. Event: ",a)}function v(a){for(var b,c=a.split("\r\n"),d=0;d<c.length;d++)if(-1!==c[d].search("m=audio")){b=d;break}if(null===b)return a;for(d=0;d<c.length;d++)if(-1!==c[d].search("opus/48000")){var e=w(c[d],/:(\d+) opus\/48000/i);e&&(c[b]=x(c[b],e));break}return c=y(c,b),a=c.join("\r\n")}function w(a,b){var c=a.match(b);return c&&2===c.length?c[1]:null}function x(a,b){for(var c=a.split(" "),d=[],e=0,f=0;f<c.length;f++)3===e&&(d[e++]=b),c[f]!==b&&(d[e++]=c[f]);return d.join(" ")}function y(a,b){for(var c=a[b].split(" "),d=a.length-1;d>=0;d--){var e=w(a[d],/a=rtpmap:(\d+) CN\/\d+/i);if(e){var f=c.indexOf(e);-1!==f&&c.splice(f,1),a.splice(d,1)}}return a[b]=c.join(" "),a}var z=io.connect("http://localhost:5000");console.log("videochat controller"),$("#remoteVideo").hide(),$("#localVideo").hide();var A,B,C,D,E,F,G,H,I=!1,J=!1,K=!1,L={iceServers:[{url:"stun:stun.acrobits.cz:3478"}]},M={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},N=document.querySelector("#localVideo"),O=document.querySelector("#remoteVideo"),P={audio:!0,video:!0};a.endCall=function(){console.log("End Call Fired"),c.wasRedirected=!0,z.emit("endCall",{user:"whatever for now"})},a.redirect=function(){b.path("/lobby")},a.createConnection=function(){H="kiosk",G="1",z.emit("create or join",G),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,navigator.getUserMedia(P,f,g),navigator.mozGetUserMedia&&(K=!0),"localhost"!=location.hostname&&t("https://computeengineondemand.appspot.com/turn?username=41784574&key=4080218913")},z.on("chat",function(a){console.log(a),$("#chat").append("<span style='color:red;padding-left: 5px;'>"+a.user+"</spna>: "+a.msg+"</br>")}),$("#msg").keypress(function(a){if(13===a.keyCode){if(""===H)return alert("Join Room First"),!1;if(""===$("#msg").val())return!1;var b=$("#msg").val(),c={user:A,msg:b};z.emit("chat",c),$("#chat").append("<span style='color:green;padding-left: 5px;'>Me</spna>: "+c.msg+"</br>"),$("#msg").val("")}}),z.on("created",function(a){console.log("Created room "+a),I=!0}),z.on("full",function(a){console.log("Room"+a+" is full.")}),z.on("redirecting",function(a){}),z.on("join",function(a){console.log("Another peer made a request to join room "+a),console.log("This peer is the initiator of room "+a+"!"),B=!0}),z.on("joined",function(a){console.log("Room "+a+" Successsfully joined."),B=!0}),z.on("message",function(a){if("Got user media"===a)h();else if("offer"===a.type)I||J||h(),E.setRemoteDescription(new j(a)),q();else if("answer"===a.type&&J)E.setRemoteDescription(new j(a));else if("candidate"===a.type&&J){var b=k({sdpMLineIndex:a.label,candidate:a.candidate});E.addIceCandidate(b)}}),window.onbeforeunload=function(a){d("bye")},a.createConnection()}]),myApp.factory("redirector",function(){var a=!1;return{wasRedirected:a}});