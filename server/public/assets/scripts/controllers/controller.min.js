/*! rtc.io 2016-02-03 */
var myApp=angular.module("myApp");myApp.controller("HomeController",["$scope","$location",function(a){console.log("home controller")}]),myApp.controller("AboutController",["$scope","$location",function(a){console.log("about controller")}]),myApp.controller("LocationsController",["$scope","$location",function(a){console.log("locations controller")}]),myApp.controller("UserController",["$scope","$location","ngAudio",function(a,b,c){console.log("user controller"),a.option="",a.options=["option1","option2","option3","option4","option5","option6"],a.i=0,a.link=!1,a.answered=!1,a.loggedIn=!1;var d=io.connect("http://localhost:5000");d.on("entrance",function(a){}),d.on("optionArray",function(b){var c=b.array;if(console.log(c),c.length>0)for(var d=0;d<c.length;d++)a.listChecker(c[d],a.options)}),d.on("keepConnected",function(b){a.connectionKeeper()}),d.on("invite",function(b){console.log("you have been invited"+b.link),a.incomingCall(),a.soundFunction()}),d.on("accepted",function(b){a.acceptedFunction()}),d.on("exit",function(a){console.log("this id was disconnceted"+a.who)}),a.loginFunction=function(b){console.log(b),a.loggedIn=!0,d.emit("login",{option:b})},a.soundFunction=function(){a.i++,a.audio=c.load("http://www.soundjay.com/phone/sounds/telephone-ring-03a.mp3"),a.audio.play(),console.log("ring "+a.i),a.i<4&&0==a.answered?setTimeout(a.soundFunction,6e3):a.i>=4&&0==a.answered&&(console.log(a.option),d.emit("noAnswer",{option:a.option}),a.i=0,a.link=!1)},a.incomingCall=function(){a.link=!0},a.acceptedFunction=function(){a.link=!1,a.answered=!0},a.getOptions=function(){d.emit("getOptions")},a.receivingCall=function(){console.log("i am taking the call"),d.emit("callAccepted",{option:a.option})},a.listChecker=function(a,b){console.log(a),console.log(b);for(var c=0;c<b.length;c++)a==b[c]&&b.splice(c,1)},a.connectionKeeper=function(){console.log("keeping connection"),setTimeout(a.connectionKeeper,15e3)},a.getOptions()}]),myApp.controller("LobbyController",["$scope","$location","fromKiosk",function(a,b,c){console.log("lobby controller");var d=io.connect("http://localhost:5000");a.unavailable=!1,console.log("option value at page login"+a.option),d.on("call",function(a){console.log("call has been made")}),d.on("unavailable",function(b){a.unavailable=!a.unavailable}),a.callFunction=function(){c.fromKiosk=!0,d.emit("call",{call:a.option})}}]),myApp.controller("VideoChatController",["$scope","fromKiosk","$route",function(a,b,c){function d(a){A.emit("message",a)}function f(a){console.log("Adding local stream."),N.src=window.URL.createObjectURL(a),C=a,d("Got user media"),$("#localimg").hide(),$("#localVideo").show(),I&&h()}function g(a){console.log("navigator.getUserMedia error: ",a)}function h(){!J&&"undefined"!=typeof C&&B&&(i(),E.addStream(C),J=!0,I&&p())}function i(){try{var a=null;E=new l(a,{optional:[{RtpDataChannels:!0}]}),E.onicecandidate=m,E.onaddstream=n,E.onremovestream=u}catch(b){return console.log("Failed to create PeerConnection, exception: "+b.message),void alert("Cannot create RTCPeerConnection object.")}}function j(a){return K?new mozRTCSessionDescription(a):new RTCSessionDescription(a)}function k(a){return K?new mozRTCIceCandidate(a):new RTCIceCandidate(a)}function l(a){return K?new mozRTCPeerConnection(a):new webkitRTCPeerConnection(a)}function m(a){a.candidate?d({type:"candidate",label:a.candidate.sdpMLineIndex,id:a.candidate.sdpMid,candidate:a.candidate.candidate}):(console.log("End of candidates."),$("#remoteimg").hide(),$("#remoteVideo").show())}function n(a){console.log("Remote stream added."),O.src=window.URL.createObjectURL(a.stream),D=a.stream}function o(a){console.log("createOffer() error: ",e)}function p(){console.log("Sending offer to peer"),E.createOffer(r,o)}function q(){console.log("Sending answer to peer."),K?E.createAnswer(r,s,M):E.createAnswer(r,null,M)}function r(a){a.sdp=w(a.sdp),E.setLocalDescription(a),d(a)}function s(a){console.log("createAnswer() error: ",e)}function t(a){var b=!1;for(var c in L.iceServers)if("turn:"===L.iceServers[c].url.substr(0,5)){b=!0,F=!0;break}if(!b){console.log("Getting TURN server from ",a);var d=new XMLHttpRequest;d.onreadystatechange=function(){if(4===d.readyState&&200===d.status){var a=JSON.parse(d.responseText);console.log("Got TURN server: ",a),L.iceServers.push({url:"turn:"+a.username+"@"+a.turn,credential:a.password}),F=!0}},d.open("GET",a,!0),d.send()}}function n(a){console.log("Remote stream added."),O.src=window.URL.createObjectURL(a.stream),D=a.stream}function u(a){console.log("Remote stream removed. Event: ",a)}function v(){console.log("Session terminated."),stop(),I=!1}function w(a){console.log("does any of this happen");for(var b,c=a.split("\r\n"),d=0;d<c.length;d++)if(-1!==c[d].search("m=audio")){b=d;break}if(null===b)return a;for(d=0;d<c.length;d++)if(-1!==c[d].search("opus/48000")){var e=x(c[d],/:(\d+) opus\/48000/i);e&&(c[b]=y(c[b],e));break}return c=z(c,b),a=c.join("\r\n")}function x(a,b){var c=a.match(b);return c&&2===c.length?c[1]:null}function y(a,b){console.log("does any of this happen");for(var c=a.split(" "),d=[],e=0,f=0;f<c.length;f++)3===e&&(d[e++]=b),c[f]!==b&&(d[e++]=c[f]);return d.join(" ")}function z(a,b){console.log("does any of this happen");for(var c=a[b].split(" "),d=a.length-1;d>=0;d--){var e=x(a[d],/a=rtpmap:(\d+) CN\/\d+/i);if(e){var f=c.indexOf(e);-1!==f&&c.splice(f,1),a.splice(d,1)}}return a[b]=c.join(" "),a}var A=io.connect("http://localhost:5000");console.log("videochat controller"),console.log("from kiosk indicator"+b.fromKiosk),a.kiosk=b.fromKiosk,console.log("scope.kiosk "+a.kiosk),$("#remoteVideo").hide(),$("#localVideo").hide();var B,C,D,E,F,G,H,I=!1,J=!1,K=!1,L={iceServers:[{url:"stun:stun.acrobits.cz:3478"}]},M={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},N=document.querySelector("#localVideo"),O=document.querySelector("#remoteVideo"),P={audio:!0,video:!0};a.endCall=function(){console.log("End Call Fired"),A.emit("endCall",{user:"whatever for now"}),window.location.href="#/user";for(var a=C.getTracks(),b=0;b<a.length;b++)a[b].stop()},a.sendSomething=function(){A.emit("something")},a.redirect=function(){console.log("redirect?"),window.location.href="#/lobby"},a.createConnection=function(){H="kiosk",G="1",A.emit("create or join",G),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,navigator.getUserMedia(P,f,g),navigator.mozGetUserMedia&&(K=!0),"localhost"!=location.hostname&&t("https://computeengineondemand.appspot.com/turn?username=41784574&key=4080218913")},A.on("created",function(a){console.log("Created room "+a),I=!0}),A.on("full",function(a){console.log("Room"+a+" is full.")}),A.on("redirect",function(b){for(var c=C.getTracks(),d=0;d<c.length;d++)c[d].stop();console.log("bye"),a.redirect()}),A.on("join",function(a){console.log("Another peer made a request to join room "+a),console.log("This peer is the initiator of room "+a+"!"),B=!0}),A.on("joined",function(a){console.log("Room "+a+" Successsfully joined."),B=!0}),A.on("message",function(a){if("Got user media"===a)h();else if("offer"===a.type)I||J||h(),E.setRemoteDescription(new j(a)),q();else if("answer"===a.type&&J)E.setRemoteDescription(new j(a));else if("candidate"===a.type&&J){var b=k({sdpMLineIndex:a.label,candidate:a.candidate});E.addIceCandidate(b)}else"bye"===a&&J&&v()}),window.onbeforeunload=function(a){d("bye")},a.createConnection()}]),myApp.factory("fromKiosk",function(){var a=!1;return{fromKiosk:a}});