/*! rtc.io 2016-02-19 */
var myApp=angular.module("myApp");myApp.controller("HomeController",["$scope",function(a){console.log("home controller")}]),myApp.controller("AboutController",["$scope",function(a){console.log("about controller")}]),myApp.controller("ProjectsController",["$scope",function(a){console.log("projects controller"),a.myInterval=8e3,a.slides=[{image:"assets/styles/images/aviConferenceRoom.jpg"},{image:"assets/styles/images/aviCorona.jpg"},{image:"assets/styles/images/aviNetsmart.jpg"},{image:"assets/styles/images/aviDigitalMenu.jpeg"}]}]),myApp.controller("LocationsController",["$scope",function(a){console.log("locations controller")}]),myApp.controller("UserController",["$scope","$location","ngAudio","reloader","$window","fromKiosk",function(a,b,c,d,e,f){console.log("user controller"),a.option="",a.options=["option1","option2","option3","option4","option5","option6"],a.i=0,a.link=!1,a.answered=!1,a.loggedIn=!1,a.reloadCount=d.userReloader,a.audio=c.load("http://www.soundjay.com/phone/sounds/telephone-ring-03a.mp3"),console.log("reload count on page load"+a.reloadCount);var g=io.connect("https://AVI9CSJWW1",{secure:!0});g.on("entrance",function(a){}),g.on("tookCall",function(b){console.log(b.option),a.option=b.option,a.loginFunction(b.option)}),g.on("optionArray",function(b){a.options=["option1","option2","option3","option4","option5","option6"];var c=b.array;if(console.log(c),c.length>0)for(var d=0;d<c.length;d++)a.listChecker(c[d],a.options)}),g.on("keepConnected",function(a){console.log("keeping connection"),setTimeout(function(){g.emit("stayConnected")},3e4)}),g.on("invite",function(b){console.log("you have been invited"+b.link),a.incomingCall(),a.soundFunction()}),g.on("exit",function(a){console.log("this id was disconnceted"+a.who)}),a.reloadFunction=function(a){1==a?(console.log("reloading route"),e.location.reload()):console.log("didnt run"),d.userReloader=0},a.relogIn=function(){g.emit("relogIn")},a.loginFunction=function(b){console.log(b),a.loggedIn=!0,g.emit("login",{option:b})},a.soundFunction=function(){0==a.answered&&(a.audio.play(),a.i++),console.log("ring "+a.i),a.i<4&&0==a.answered?setTimeout(a.soundFunction,6e3):a.i>=4&&0==a.answered&&(g.emit("noAnswer",{option:a.option}),a.i=0,a.link=!1)},a.incomingCall=function(){a.link=!0},a.getOptions=function(){g.emit("getOptions")},a.receivingCall=function(){a.link=!1,a.answered=!0,f.fromKiosk=!1,d.userReloader=1,d.lobbyReloader=1,console.log("i am taking the call"),g.emit("callAccepted",{option:a.option})},a.listChecker=function(a,b){console.log(a),console.log(b);for(var c=0;c<b.length;c++)a==b[c]&&b.splice(c,1)},a.connectionKeeper=function(){},a.reloadFunction(a.reloadCount),a.relogIn(),a.getOptions()}]),myApp.controller("LobbyController",["$scope","$location","fromKiosk","reloader","$window","$route",function(a,b,c,d,e,f){console.log("lobby controller");var g=io.connect("https://AVI9CSJWW1",{secure:!0});a.yo=!1,a.reloadCount=d.lobbyReloader,console.log("reload count on page load"+a.reloadCount),a.reloadFunction=function(a){1==a?(console.log("reloading route"),e.location.reload()):console.log("didnt run"),d.lobbyReloader=0},a.reloadFunction(a.reloadCount),g.on("call",function(a){console.log("call has been made")}),a.callFunction=function(){c.fromKiosk=!0,d.lobbyReloader=1,console.log(c.fromKiosk,d.lobbyReloader),g.emit("call",{call:a.option})}}]),myApp.controller("VideoChatController",["$scope","fromKiosk","$route","reloader","$window",function(a,b,c,d,f){function g(a){H.emit("message",a)}function h(b){console.log("Adding local stream."),F.src=window.URL.createObjectURL(b),a.localVideoStream=b,g("Got user media"),$("#localimg").hide(),$("#localVideo").show(),z&&j()}function i(a){console.log("navigator.getUserMedia error: ",a)}function j(){!A&&"undefined"!=typeof a.localVideoStream&&y&&(k(),a.pc.addStream(a.localVideoStream),A=!0,z&&q())}function k(){try{var b=null;a.pc=new n(b,{optional:[{RtpDataChannels:!0}]}),console.log("socket message createPeerConnection begginning "+a.pc.signalingState),a.pc.onicecandidate=o,a.pc.onaddstream=v,a.pc.onremovestream=w}catch(c){return console.log("Failed to create PeerConnection, exception: "+c.message),void alert("Cannot create RTCPeerConnection object.")}}function l(a){return C?new mozRTCSessionDescription(a):new RTCSessionDescription(a)}function m(a){return C?new mozRTCIceCandidate(a):new RTCIceCandidate(a)}function n(a){return C?new mozRTCPeerConnection(a):new webkitRTCPeerConnection(a)}function o(a){a.candidate?g({type:"candidate",label:a.candidate.sdpMLineIndex,id:a.candidate.sdpMid,candidate:a.candidate.candidate}):(console.log("End of candidates."),$("#remoteimg").hide(),$("#remoteVideo").show())}function p(a){console.log("createOffer() error: ",e)}function q(){console.log("Sending offer to peer"),a.pc.createOffer(s,p)}function r(){console.log("begginning of do answer"+a.counter),console.log("Sending answer to peer."),C?a.pc.createAnswer(s,t,E):a.pc.createAnswer(s,null,E),a.counter++,console.log("end of do answer"+a.counter)}function s(b){a.pc.setLocalDescription(b),g(b)}function t(a){console.log("createAnswer() error: ",e)}function u(a){var b=!1;for(var c in D.iceServers)if("turn:"===D.iceServers[c].url.substr(0,5)){b=!0,B=!0;break}if(!b){console.log("Getting TURN server from ",a);var d=new XMLHttpRequest;d.onreadystatechange=function(){if(4===d.readyState&&200===d.status){var a=JSON.parse(d.responseText);console.log("Got TURN server: ",a),D.iceServers.push({url:"turn:"+a.username+"@"+a.turn,credential:a.password}),B=!0}},d.open("GET",a,!0),d.send()}}function v(b){console.log("Remote stream added."),G.src=window.URL.createObjectURL(b.stream),a.remoteVideoStream=b.stream}function w(a){console.log("Remote stream removed. Event: ",a)}function x(){console.log("Session terminated."),z=!1}console.log("videochat controller"),console.log("from kiosk indicator "+b.fromKiosk),a.kiosk=b.fromKiosk,a.unavailable=!1,a.counter=0,$("#remoteVideo").hide(),$("#localVideo").hide();var y,z=!1,A=!1;a.localVideoStream,a.remoteVideoStream;var B,C=!1,D={iceServers:[{url:"stun:stun.acrobits.cz:3478"}]},E={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},F=document.querySelector("#localVideo"),G=document.querySelector("#remoteVideo");a.room;var H=io.connect("https://AVI9CSJWW1",{secure:!0}),I={audio:!0,video:!0};a.endCall=function(){for(var b=a.localVideoStream.getTracks(),c=0;c<b.length;c++)b[c].stop();a.pc.close(),d.lobbyReloader=1,d.userReloader=1,H.emit("endCall",{user:"whatever for now"}),window.location.href="#/user"},a.createConnection=function(){a.room="1",H.emit("create or join",a.room),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,navigator.getUserMedia(I,h,i),navigator.mozGetUserMedia&&(C=!0),"localhost"!=location.hostname&&u("https://computeengineondemand.appspot.com/turn?username=41784574&key=4080218913")},H.on("created",function(a){console.log("Created room "+a),z=!0}),H.on("full",function(b){console.log("Room"+b+" is full."),a.yo=!1}),H.on("redirect",function(b){for(var c=a.localVideoStream.getTracks(),e=0;e<c.length;e++)c[e].stop();a.pc.close(),d.lobbyReloader=1,console.log("bye"),window.location.href="#/home"}),H.on("unavailable",function(b){console.log("this aint happening"),a.$apply(function(){a.kiosk=!1,a.unavailable=!0,console.log(a.unavailable)}),d.lobbyReloader=1,setTimeout(function(){f.location.href="/#lobby"},8e3)}),H.on("join",function(a){console.log("Another peer made a request to join room "+a),console.log("This peer is the initiator of room "+a+"!"),y=!0}),H.on("joined",function(a){console.log("Room "+a+" Successsfully joined."),y=!0}),H.on("sendSomething",function(b){console.log("sendSomething"),a.$apply(function(){a.kiosk=!1})}),H.on("message",function(b){if("Got user media"===b)j();else if("offer"===b.type)z||A||j(),a.pc.setRemoteDescription(new l(b)),a.counter<1&&r();else if("answer"===b.type&&A)a.pc.setRemoteDescription(new l(b));else if("candidate"===b.type&&A){var c=m({sdpMLineIndex:b.label,candidate:b.candidate});a.pc.addIceCandidate(c)}else"bye"===b&&A&&x()}),window.onbeforeunload=function(a){g("bye")},a.createConnection()}]),myApp.factory("fromKiosk",function(){var a=!1;return{fromKiosk:a}}),myApp.factory("reloader",function(){var a,b;return{reloader:a,reloader:b}});