/*! rtc.io 2016-02-04 */
var myApp=angular.module("myApp");myApp.controller("HomeController",["$scope","$location",function(a){console.log("home controller")}]),myApp.controller("AboutController",["$scope","$location",function(a){console.log("about controller")}]),myApp.controller("LocationsController",["$scope","$location",function(a){console.log("locations controller")}]),myApp.controller("UserController",["$scope","$location","ngAudio","reloader","$window",function(a,b,c,d,e){console.log("user controller"),a.option="",a.options=["option1","option2","option3","option4","option5","option6"],a.i=0,a.link=!1,a.answered=!1,a.loggedIn=!1,a.reloadCount=d.reloader,a.audio=c.load("http://www.soundjay.com/phone/sounds/telephone-ring-03a.mp3"),console.log("reload count on page load"+a.reloadCount),a.reloadFunction=function(a){1==a?e.location.reload():console.log("didnt run"),d.vreloader=0},a.reloadFunction(a.reloadCount);var f=io.connect("http://localhost:5000");f.on("entrance",function(a){}),f.on("optionArray",function(b){a.options=["option1","option2","option3","option4","option5","option6"];var c=b.array;if(console.log(c),c.length>0)for(var d=0;d<c.length;d++)a.listChecker(c[d],a.options)}),f.on("keepConnected",function(a){console.log("keeping connection"),setTimeout(function(){f.emit("stayConnected")},2e4)}),f.on("invite",function(b){console.log("you have been invited"+b.link),a.incomingCall(),a.soundFunction()}),f.on("exit",function(a){console.log("this id was disconnceted"+a.who)}),a.loginFunction=function(b){console.log(b),a.loggedIn=!0,f.emit("login",{option:b})},a.soundFunction=function(){a.i++,a.audio.play(),console.log("ring "+a.i),a.i<4&&0==a.answered?setTimeout(a.soundFunction,6e3):a.i>=4&&0==a.answered&&(f.emit("noAnswer",{option:a.option}),a.i=0,a.link=!1)},a.incomingCall=function(){a.link=!0},a.getOptions=function(){f.emit("getOptions")},a.receivingCall=function(){a.link=!1,a.answered=!0,d.reloader=1,console.log("i am taking the call"),f.emit("callAccepted",{option:a.option})},a.listChecker=function(a,b){console.log(a),console.log(b);for(var c=0;c<b.length;c++)a==b[c]&&b.splice(c,1)},a.connectionKeeper=function(){},a.getOptions()}]),myApp.controller("LobbyController",["$scope","$location","fromKiosk","reloader","$window",function(a,b,c,d,e){console.log("lobby controller");var f=io.connect("http://localhost:5000");a.yo=!1,a.reloadCount=d.reloader,console.log("reload count on page load"+a.reloadCount),a.reloadFunction=function(a){1==a?e.location.reload():console.log("didnt run"),d.reloader=0},a.reloadFunction(a.reloadCount),console.log("option value at page login"+a.option),f.on("call",function(a){console.log("call has been made")}),a.callFunction=function(){d.reloader=1,c.fromKiosk=!0,f.emit("call",{call:a.option})}}]),myApp.controller("VideoChatController",["$scope","fromKiosk","$route","reloader","$window",function(a,b,c,d,f){function g(a){P.emit("message",a)}function h(a){console.log("Adding local stream."),L.src=window.URL.createObjectURL(a),C=a,g("Got user media"),$("#localimg").hide(),$("#localVideo").show(),G&&j()}function i(a){console.log("navigator.getUserMedia error: ",a)}function j(){!H&&"undefined"!=typeof C&&B&&(k(),E.addStream(C),H=!0,G&&r())}function k(){try{var a=null;E=new n(a,{optional:[{RtpDataChannels:!0}]}),E.onicecandidate=o,E.onaddstream=p}catch(b){return console.log("Failed to create PeerConnection, exception: "+b.message),void alert("Cannot create RTCPeerConnection object.")}}function l(a){return I?new mozRTCSessionDescription(a):new RTCSessionDescription(a)}function m(a){return I?new mozRTCIceCandidate(a):new RTCIceCandidate(a)}function n(a){return I?new mozRTCPeerConnection(a):new webkitRTCPeerConnection(a)}function o(a){a.candidate?g({type:"candidate",label:a.candidate.sdpMLineIndex,id:a.candidate.sdpMid,candidate:a.candidate.candidate}):(console.log("End of candidates."),$("#remoteimg").hide(),$("#remoteVideo").show())}function p(a){console.log("Remote stream added."),M.src=window.URL.createObjectURL(a.stream),D=a.stream}function q(a){console.log("createOffer() error: ",e)}function r(){console.log("Sending offer to peer"),E.createOffer(t,q)}function s(){console.log("Sending answer to peer."),I?E.createAnswer(t,u,K):E.createAnswer(t,null,K)}function t(a){a.sdp=w(a.sdp),E.setLocalDescription(a),g(a)}function u(a){console.log("createAnswer() error: ",e)}function v(a){var b=!1;for(var c in J.iceServers)if("turn:"===J.iceServers[c].url.substr(0,5)){b=!0,F=!0;break}if(!b){console.log("Getting TURN server from ",a);var d=new XMLHttpRequest;d.onreadystatechange=function(){if(4===d.readyState&&200===d.status){var a=JSON.parse(d.responseText);console.log("Got TURN server: ",a),J.iceServers.push({url:"turn:"+a.username+"@"+a.turn,credential:a.password}),F=!0}},d.open("GET",a,!0),d.send()}}function p(a){console.log("Remote stream added."),M.src=window.URL.createObjectURL(a.stream),D=a.stream}function w(a){console.log("does any of this happen");for(var b,c=a.split("\r\n"),d=0;d<c.length;d++)if(-1!==c[d].search("m=audio")){b=d;break}if(null===b)return a;for(d=0;d<c.length;d++)if(-1!==c[d].search("opus/48000")){var e=x(c[d],/:(\d+) opus\/48000/i);e&&(c[b]=y(c[b],e));break}return c=z(c,b),a=c.join("\r\n")}function x(a,b){var c=a.match(b);return c&&2===c.length?c[1]:null}function y(a,b){console.log("does any of this happen");for(var c=a.split(" "),d=[],e=0,f=0;f<c.length;f++)3===e&&(d[e++]=b),c[f]!==b&&(d[e++]=c[f]);return d.join(" ")}function z(a,b){console.log("does any of this happen");for(var c=a[b].split(" "),d=a.length-1;d>=0;d--){var e=x(a[d],/a=rtpmap:(\d+) CN\/\d+/i);if(e){var f=c.indexOf(e);-1!==f&&c.splice(f,1),a.splice(d,1)}}return a[b]=c.join(" "),a}console.log("videochat controller"),console.log("from kiosk indicator"+b.fromKiosk),a.kiosk=b.fromKiosk,a.yo=!1,console.log("scope.kiosk "+a.kiosk),$("#remoteVideo").hide(),$("#localVideo").hide();var A,B,C,D,E,F,G=!1,H=!1,I=!1,J={iceServers:[{url:"stun:stun.acrobits.cz:3478"}]},K={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},L=document.querySelector("#localVideo"),M=document.querySelector("#remoteVideo"),N=location.pathname.substring(1),O=location.pathname.substring(2),P=io.connect(),Q={audio:!0,video:!0};a.endCall=function(){P.emit("endCall",{user:"whatever for now"}),d.reloader=1},a.sendSomething=function(){P.emit("something")},a.redirect=function(){d.reloader=1,f.location.href="#/lobby"},a.createConnection=function(){O="kiosk",N="1",P.emit("create or join",N),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,navigator.getUserMedia(Q,h,i),navigator.mozGetUserMedia&&(I=!0),"localhost"!=location.hostname&&v("https://computeengineondemand.appspot.com/turn?username=41784574&key=4080218913")},P.on("created",function(a){console.log("Created room "+a),G=!0,A='<h1 class="yo">Thanks for calling, were just waiting for someone to pick up!</h1>',$(".main").append(A)}),P.on("full",function(a){console.log("Room"+a+" is full.")}),P.on("redirect",function(b){for(var c=C.getTracks(),d=0;d<c.length;d++)c[d].stop();console.log("bye"),a.redirect()}),P.on("unavailable",function(a){A="<h1 class='yo'>Sorry no one is there</h1>",$(".main").append(A),d.reloader=1,setTimeout(function(){f.location.href="/#lobby"},13e3)}),P.on("join",function(a){console.log("Another peer made a request to join room "+a),console.log("This peer is the initiator of room "+a+"!"),B=!0}),P.on("joined",function(a){console.log("Room "+a+" Successsfully joined."),B=!0}),P.on("message",function(a){if("Got user media"===a)j();else if("offer"===a.type)G||H||j(),E.setRemoteDescription(new l(a)),s();else if("answer"===a.type&&H)E.setRemoteDescription(new l(a));else if("candidate"===a.type&&H){var b=m({sdpMLineIndex:a.label,candidate:a.candidate});E.addIceCandidate(b)}else"bye"===a&&H&&handleRemoteHangup()}),window.onbeforeunload=function(a){g("bye")},a.createConnection()}]),myApp.factory("fromKiosk",function(){var a=!1;return{fromKiosk:a}}),myApp.factory("reloader",function(){var a=0;return{reloader:a}});